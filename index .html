<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Live Market Dashboard with Admin</title>
<style>
:root{--bg:#121212;--card:#1e1e1e;--muted:#888}
body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#fff}
header{padding:12px 16px;text-align:center}
.top{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;padding:8px 12px}
.tab{padding:8px 14px;background:#333;border-radius:8px;cursor:pointer}
.tab.active{background:#0066ff}
.controls{display:flex;gap:8px;justify-content:center;padding:8px;flex-wrap:wrap}
.control-btn{padding:8px 12px;background:#333;border-radius:8px;cursor:pointer}
.control-btn.active{background:#0066ff}
.container{max-width:1100px;margin:12px auto;padding:0 12px}
#ticker-wrap{background:var(--card);border-radius:8px;padding:8px;overflow:hidden;white-space:nowrap;margin-bottom:12px}
#ticker{display:inline-block;animation:scroll 60s linear infinite} /* slower scroll */
@keyframes scroll{0%{transform:translateX(100%)}100%{transform:translateX(-100%)}}
table{width:100%;border-collapse:collapse;background:transparent}
th,td{padding:10px;border-bottom:1px solid #2b2b2b;text-align:left}
th{color:var(--muted);font-weight:600}
tr:hover{background:#171717;cursor:pointer}
.up{color:#2ad26a;font-weight:600}
.down{color:#ff6b6b;font-weight:600}
#chart{margin-top:16px;border-radius:8px;overflow:hidden}
.small{font-size:13px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center}
.search{padding:8px 10px;border-radius:8px;border:0;background:#222;color:#fff;width:240px}
.right{margin-left:auto}
.admin-btn{padding:6px 10px;background:#0066ff;border-radius:6px;cursor:pointer;color:#fff;margin-left:10px}
/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);justify-content:center;align-items:center;z-index:999}
.modal-content{background:#1e1e1e;padding:20px;border-radius:8px;max-height:90%;overflow:auto;width:90%;max-width:800px}
.close{float:right;cursor:pointer;font-weight:bold;font-size:20px}
.input-pass{padding:6px;width:120px;border-radius:6px;border:none;margin-right:8px}
.asset-row{display:flex;gap:6px;margin-bottom:4px;align-items:center}
.asset-row input[type=checkbox]{margin-right:6px}
#adminSearch{width:100%;margin:8px 0;padding:6px;border-radius:6px;border:none;background:#222;color:#fff}
</style>
</head>
<body>
<header>
  <h1>ðŸ“ˆ Live Market Dashboard</h1>
  <div class="top">
    <div class="tab active" id="tab-crypto">Crypto</div>
    <div class="tab" id="tab-stocks">Stocks</div>
    <input id="search" class="search" placeholder="Search (name or symbol)"/>
    <div class="admin-btn" id="openAdmin">Admin Panel</div>
  </div>
</header>

<div class="container">
  <div id="ticker-wrap"><div id="ticker">Loading tickerâ€¦</div></div>

  <div class="controls">
    <div class="control-btn active" id="filter-all">All</div>
    <div class="control-btn" id="filter-gainers">Top Gainers</div>
    <div class="control-btn" id="filter-losers">Top Losers</div>
    <div class="small right" id="lastUpdated">Last update: â€”</div>
  </div>

  <table>
    <thead>
      <tr><th style="width:80px">Symbol</th><th>Name</th><th style="width:140px">Price (USD)</th><th style="width:120px">24h %</th></tr>
    </thead>
    <tbody id="assetTable"></tbody>
  </table>

  <div id="chart"></div>
</div>

<!-- Admin Modal -->
<div class="modal" id="adminModal">
  <div class="modal-content">
    <span class="close" id="closeAdmin">&times;</span>
    <h2>Admin Panel</h2>
    <div>
      <input type="password" id="adminPass" class="input-pass" placeholder="Enter Password"/>
      <button id="loginAdmin">Login</button>
    </div>
    <div id="adminContent" style="display:none;margin-top:12px">
      <input type="text" id="adminSearch" placeholder="Search asset in admin panel"/>
      <div style="margin-bottom:6px;">
        <button id="selectAll">Select All</button>
        <button id="deselectAll">Deselect All</button>
      </div>
      <div id="adminList"></div>
    </div>
  </div>
</div>

<script src="https://s3.tradingview.com/tv.js"></script>
<script>
const FINNHUB_KEY="d3f59nhr01qh40fgtvv0d3f59nhr01qh40fgtvvg";
const REFRESH_MS=1000;

// Assets: initial top + extra 20+ disabled by default
let CRYPTOS=[
{id:'bitcoin',sym:'BTC',name:'Bitcoin',tv:'BINANCE:BTCUSDT',enabled:true},
{id:'ethereum',sym:'ETH',name:'Ethereum',tv:'BINANCE:ETHUSDT',enabled:true},
{id:'binancecoin',sym:'BNB',name:'BNB',tv:'BINANCE:BNBUSDT',enabled:true},
{id:'ripple',sym:'XRP',name:'XRP',tv:'BINANCE:XRPUSDT',enabled:true},
{id:'cardano',sym:'ADA',name:'Cardano',tv:'BINANCE:ADAUSDT',enabled:true},
{id:'dogecoin',sym:'DOGE',name:'Dogecoin',tv:'BINANCE:DOGEUSDT',enabled:true},
{id:'solana',sym:'SOL',name:'Solana',tv:'BINANCE:SOLUSDT',enabled:true},
// extra cryptos disabled initially
{id:'polkadot',sym:'DOT',name:'Polkadot',tv:'BINANCE:DOTUSDT',enabled:false},
{id:'avalanche',sym:'AVAX',name:'Avalanche',tv:'BINANCE:AVAXUSDT',enabled:false},
{id:'chainlink',sym:'LINK',name:'Chainlink',tv:'BINANCE:LINKUSDT',enabled:false},
{id:'litecoin',sym:'LTC',name:'Litecoin',tv:'BINANCE:LTCUSDT',enabled:false},
{id:'uniswap',sym:'UNI',name:'Uniswap',tv:'BINANCE:UNIUSDT',enabled:false},
{id:'algorand',sym:'ALGO',name:'Algorand',tv:'BINANCE:ALGOUSDT',enabled:false},
{id:'stellar',sym:'XLM',name:'Stellar',tv:'BINANCE:XLMUSDT',enabled:false},
{id:'vechain',sym:'VET',name:'VeChain',tv:'BINANCE:VETUSDT',enabled:false},
{id:'tron',sym:'TRX',name:'Tron',tv:'BINANCE:TRXUSDT',enabled:false},
{id:'ethereum-classic',sym:'ETC',name:'Ethereum Classic',tv:'BINANCE:ETCUSDT',enabled:false}
];

let STOCKS=[
{id:'AAPL',sym:'AAPL',name:'Apple',tv:'NASDAQ:AAPL',enabled:true},
{id:'MSFT',sym:'MSFT',name:'Microsoft',tv:'NASDAQ:MSFT',enabled:true},
{id:'TSLA',sym:'TSLA',name:'Tesla',tv:'NASDAQ:TSLA',enabled:true},
{id:'AMZN',sym:'AMZN',name:'Amazon',tv:'NASDAQ:AMZN',enabled:true},
{id:'GOOGL',sym:'GOOGL',name:'Alphabet',tv:'NASDAQ:GOOGL',enabled:true},
{id:'META',sym:'META',name:'Meta',tv:'NASDAQ:META',enabled:true},
{id:'NVDA',sym:'NVDA',name:'Nvidia',tv:'NASDAQ:NVDA',enabled:true},
// extra stocks disabled initially
{id:'NFLX',sym:'NFLX',name:'Netflix',tv:'NASDAQ:NFLX',enabled:false},
{id:'ADBE',sym:'ADBE',name:'Adobe',tv:'NASDAQ:ADBE',enabled:false},
{id:'INTC',sym:'INTC',name:'Intel',tv:'NASDAQ:INTC',enabled:false},
{id:'CSCO',sym:'CSCO',name:'Cisco',tv:'NASDAQ:CSCO',enabled:false},
{id:'PYPL',sym:'PYPL',name:'PayPal',tv:'NASDAQ:PYPL',enabled:false},
{id:'ORCL',sym:'ORCL',name:'Oracle',tv:'NASDAQ:ORCL',enabled:false},
{id:'IBM',sym:'IBM',name:'IBM',tv:'NYSE:IBM',enabled:false},
{id:'BA',sym:'BA',name:'Boeing',tv:'NYSE:BA',enabled:false},
{id:'SHOP',sym:'SHOP',name:'Shopify',tv:'NYSE:SHOP',enabled:false},
{id:'TWTR',sym:'TWTR',name:'Twitter',tv:'NYSE:TWTR',enabled:false}
];

let ALL=[...CRYPTOS,...STOCKS];
let currentCategory='crypto', currentFilter='all', lastPrices={}, lastPercents={}, currentTVSymbol=null;

// Load saved enabled status from localStorage
function loadEnabled(){
  const saved=localStorage.getItem('enabledAssets');
  if(saved){const obj=JSON.parse(saved); ALL.forEach(a=>{if(obj.hasOwnProperty(a.sym)) a.enabled=obj[a.sym];});}
}
function saveEnabled(){const obj={};ALL.forEach(a=>{obj[a.sym]=a.enabled;}); localStorage.setItem('enabledAssets',JSON.stringify(obj));}

/* Helpers */
const $=id=>document.getElementById(id);
const setActiveTab=which=>{$('tab-crypto').classList.toggle('active',which==='crypto');$('tab-stocks').classList.toggle('active',which==='stocks');};
const setActiveFilterBtn=filter=>{['filter-all','filter-gainers','filter-losers'].forEach(id=>{$(id).classList.toggle('active', id.endsWith(filter==='all'?'all':filter==='gainers'?'gainers':'losers'));});};

function renderTable(){
  const tbody=$('assetTable'); tbody.innerHTML='';
  const search=$('search').value.trim().toLowerCase();
  let list=currentCategory==='crypto'?CRYPTOS:currentCategory==='stocks'?STOCKS:ALL;
  list=list.filter(a=>a.enabled);
  if(currentFilter!=='all'){list=list.slice().sort((a,b)=>{const pa=lastPercents[a.sym]??0,pb=lastPercents[b.sym]??0; return currentFilter==='gainers'? pb-pa: pa-pb;}).slice(0,10);}
  list.forEach(asset=>{if(search && !(asset.sym+asset.name).toLowerCase().includes(search)) return; const tr=document.createElement('tr'); tr.dataset.tv=asset.tv; tr.dataset.sym=asset.sym; tr.innerHTML=`<td>${asset.sym}</td><td>${asset.name}</td><td class="price small">Loading...</td><td class="pct small">--</td>`; tr.onclick=()=>loadTradingView(asset.tv,asset.name); tbody.appendChild(tr);});
}

function updateTicker(){
  const tickerEl=$('ticker'); let list=currentCategory==='crypto'?CRYPTOS:currentCategory==='stocks'?STOCKS:ALL;
  list=list.filter(a=>a.enabled);
  tickerEl.innerHTML=list.map(a=>{const pct=lastPercents[a.sym]??0, cls=pct>0?'up':pct<0?'down':''; const price=lastPrices[a.sym]!==undefined?`$${lastPrices[a.sym].toFixed(2)}`:'â€”'; return `<span class="${cls}" style="margin-right:28px;cursor:pointer" data-tv="${a.tv}">${a.sym} ${price} (${pct>0?'+':''}${pct.toFixed(2)}%)</span>`;}).join('');
  tickerEl.querySelectorAll('span[data-tv]').forEach(s=>{s.onclick=()=>loadTradingView(s.dataset.tv,'');});
}

async function fetchPricesOnce(){
  $('lastUpdated').innerText=`Last update: ${new Date().toLocaleTimeString()}`;
  try{
    const ids=CRYPTOS.map(c=>c.id).join(',');
    const cgUrl=`https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true`;
    const cgResp=await fetch(cgUrl); if(cgResp.ok){const cgData=await cgResp.json(); CRYPTOS.forEach(c=>{const info=cgData[c.id]; if(info&&info.usd!==undefined){lastPrices[c.sym]=info.usd; lastPercents[c.sym]=info.usd_24h_change??0;}});}
  }catch(e){console.warn('CoinGecko error',e);}
  try{
    const promises=STOCKS.map(s=>fetch(`https://finnhub.io/api/v1/quote?symbol=${s.id}&token=${FINNHUB_KEY}`).then(r=>r.ok?r.json().catch(()=>null):null).then(d=>({s,d})).catch(()=>({s,d:null})));
    const results=await Promise.all(promises);
    results.forEach(({s,d})=>{if(d&&(d.c||d.c===0)){lastPrices[s.sym]=d.c; lastPercents[s.sym]=(d.dp!==undefined&&d.dp!==null)?d.dp:(d.pc?((d.c-d.pc)/d.pc*100):0);}});
  }catch(e){console.warn('Finnhub error',e);}
  document.querySelectorAll('#assetTable tr').forEach(tr=>{const sym=tr.dataset.sym; const priceCell=tr.querySelector('.price'); const pctCell=tr.querySelector('.pct'); const p=lastPrices[sym]; const pct=lastPercents[sym]; if(p!==undefined) priceCell.textContent=`$${p.toFixed(2)}`; else priceCell.textContent='â€”'; if(pct!==undefined){pctCell.textContent=`${pct>0?'+':''}${pct.toFixed(2)}%`; pctCell.className=`pct small ${pct>0?'up':pct<0?'down':''}`; priceCell.className=`price small ${pct>0?'up':pct<0?'down':''}`;} else { pctCell.textContent='--'; pctCell.className='pct small'; }});
  updateTicker(); if(currentFilter==='gainers'||currentFilter==='losers') renderTable();
}

// Filters
$('filter-all').onclick=()=>{currentFilter='all';setActiveFilterBtn(currentFilter);renderTable();};
$('filter-gainers').onclick=()=>{currentFilter='gainers';setActiveFilterBtn(currentFilter);renderTable();};
$('filter-losers').onclick=()=>{currentFilter='losers';setActiveFilterBtn(currentFilter);renderTable();};

// Tabs
$('tab-crypto').onclick=()=>{currentCategory='crypto';setActiveTab('crypto');renderTable();fetchPricesOnce();};
$('tab-stocks').onclick=()=>{currentCategory='stocks';setActiveTab('stocks');renderTable();fetchPricesOnce();};

// TradingView Chart
function loadTradingView(tvSymbol,title){if(!tvSymbol) return; currentTVSymbol=tvSymbol; const chartDiv=$('chart'); chartDiv.innerHTML='<div id="tv_inner" style="height:600px"></div>'; try{new TradingView.widget({container_id:"tv_inner",autosize:true,symbol:tvSymbol,interval:"1",timezone:"Etc/UTC",theme:"dark",style:"1",locale:"en",toolbar_bg:"#1f1f1f",allow_symbol_change:true,hide_legend:false});}catch(e){chartDiv.innerHTML='<div class="small">Chart failed to load.</div>'; console.error(e);}}

// Search
$('search').addEventListener('input',()=>renderTable());

/* Admin Panel */
const adminModal=$('adminModal'), adminBtn=$('openAdmin'), closeAdmin=$('closeAdmin'), loginAdmin=$('loginAdmin'), adminContent=$('adminContent'), adminPass=$('adminPass'), adminList=$('adminList'), adminSearch=$('adminSearch'), selectAllBtn=$('selectAll'), deselectAllBtn=$('deselectAll');
const ADMIN_PASSWORD='admin123';

adminBtn.onclick=()=>{ adminModal.style.display='flex'; adminPass.value=''; adminContent.style.display='none'; };
closeAdmin.onclick=()=>{ adminModal.style.display='none'; };
window.onclick=e=>{if(e.target==adminModal) adminModal.style.display='none';};

loginAdmin.onclick=()=>{
  if(adminPass.value===ADMIN_PASSWORD){
    adminContent.style.display='block';
    populateAdminList();
  }else{alert('Incorrect password');}
};

function populateAdminList(){
  adminList.innerHTML='';
  const filterVal=adminSearch.value.trim().toLowerCase();
  ALL.forEach((a,i)=>{
    if(filterVal && !(a.sym+a.name).toLowerCase().includes(filterVal)) return;
    const row=document.createElement('div'); row.className='asset-row';
    const checkbox=document.createElement('input'); checkbox.type='checkbox'; checkbox.checked=a.enabled;
    checkbox.onchange=()=>{ALL[i].enabled=checkbox.checked; saveEnabled(); renderTable(); updateTicker();}
    row.appendChild(checkbox); row.appendChild(document.createTextNode(`${a.sym} - ${a.name}`));
    adminList.appendChild(row);
  });
}

// Admin search
adminSearch.addEventListener('input',()=>populateAdminList());
selectAllBtn.onclick=()=>{ALL.forEach(a=>{if(currentCategory==='crypto' && CRYPTOS.includes(a) || currentCategory==='stocks' && STOCKS.includes(a)){a.enabled=true;}}); saveEnabled(); populateAdminList(); renderTable(); updateTicker();}
deselectAllBtn.onclick=()=>{ALL.forEach(a=>{if(currentCategory==='crypto' && CRYPTOS.includes(a) || currentCategory==='stocks' && STOCKS.includes(a)){a.enabled=false;}}); saveEnabled(); populateAdminList(); renderTable(); updateTicker();}

// Init
loadEnabled();
renderTable(); fetchPricesOnce();
setInterval(fetchPricesOnce, REFRESH_MS);
</script>
</body>
</html>
